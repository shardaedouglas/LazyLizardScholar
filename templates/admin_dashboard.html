{% extends "base.html" %}

{% block title %}Admin Dashboard - CyberStudy{% endblock %}
{% block head_content %}
        <meta robots="noindex, nofollow, noarchive">
{% endblock %}
{% block content %}
<!-- Admin Dashboard Header -->
<section class="admin-header bg-gradient-danger text-white py-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="h3 fw-bold mb-2">
                    <i class="fas fa-shield-alt me-2"></i>Admin Dashboard
                </h1>
                <p class="mb-0">Manage student progress and parent accounts</p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="admin-actions">
                    <button class="btn btn-outline-light btn-sm me-2" id="refreshData">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <a href="/admin/logout" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Admin Dashboard Content -->
<section class="py-5">
    <div class="container">
        <!-- Quick Stats -->
        <div class="row g-4 mb-5">
            <div class="col-lg-3 col-md-6">
                <div class="admin-stat-card">
                    <div class="admin-stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="admin-stat-content">
                        <h3 class="admin-stat-number" id="totalStudents">0</h3>
                        <p class="admin-stat-label">Total Students</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="admin-stat-card">
                    <div class="admin-stat-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="admin-stat-content">
                        <h3 class="admin-stat-number" id="totalParents">0</h3>
                        <p class="admin-stat-label">Parent Accounts</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="admin-stat-card">
                    <div class="admin-stat-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="admin-stat-content">
                        <h3 class="admin-stat-number" id="totalProjects">0</h3>
                        <p class="admin-stat-label">Projects Completed</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="admin-stat-card">
                    <div class="admin-stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="admin-stat-content">
                        <h3 class="admin-stat-number" id="totalHours">0</h3>
                        <p class="admin-stat-label">Total Learning Hours</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Navigation Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-tabs admin-nav-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>Students
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="parents-tab" data-bs-toggle="tab" data-bs-target="#parents" type="button" role="tab">
                            <i class="fas fa-user-friends me-2"></i>Parents
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress" type="button" role="tab">
                            <i class="fas fa-chart-line me-2"></i>Progress Tracking
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabContent">
            <!-- Students Tab -->
            <div class="tab-pane fade show active" id="students" role="tabpanel">
                <div class="admin-card">
                    <div class="card-header">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-users me-2"></i>Student Management
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="studentsTable">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Age</th>
                                        <th>Level</th>
                                        <th>Parent</th>
                                        <th>Progress</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading students...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parents Tab -->
            <div class="tab-pane fade" id="parents" role="tabpanel">
                <div class="admin-card">
                    <div class="card-header">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-user-friends me-2"></i>Parent Account Management
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="parentsTable">
                                <thead>
                                    <tr>
                                        <th>Parent Name</th>
                                        <th>Email</th>
                                        <th>Students</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="parentsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading parents...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Tracking Tab -->
            <div class="tab-pane fade" id="progress" role="tabpanel">
                <div class="admin-card">
                    <div class="card-header">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-chart-line me-2"></i>Progress Overview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="progressOverview">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading progress data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Student Progress Modal -->
<div class="modal fade" id="studentProgressModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Student Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="progressForm">
                    <input type="hidden" id="studentId" name="student_id">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="currentLevel" class="form-label">Current Level</label>
                            <select class="form-select" id="currentLevel" name="current_level">
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="completedProjects" class="form-label">Completed Projects</label>
                            <input type="number" class="form-control" id="completedProjects" name="completed_projects" min="0">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="totalHours" class="form-label">Total Learning Hours</label>
                            <input type="number" class="form-control" id="totalHours" name="total_hours" min="0" step="0.5">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="achievements" class="form-label">Achievements</label>
                            <input type="number" class="form-control" id="achievements" name="achievements" min="0">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="nextClassDate" class="form-label">Next Class Date</label>
                            <input type="date" class="form-control" id="nextClassDate" name="next_class_date">
                        </div>
                        
                        <div class="col-12">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Add any notes about the student's progress..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProgress">
                    <i class="fas fa-save me-1"></i>Save Progress
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Parent Edit Modal -->
<div class="modal fade" id="parentEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Parent Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="parentEditForm">
                    <input type="hidden" id="parentId" name="parent_id">
                    
                    <div class="mb-3">
                        <label for="parentName" class="form-label">Parent Name</label>
                        <input type="text" class="form-control" id="parentName" name="parent_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="parentEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="parentEmail" name="email" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-2" id="deleteParent">
                    <i class="fas fa-trash me-1"></i>Delete Account
                </button>
                <button type="button" class="btn btn-primary" id="saveParent">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Admin dashboard functionality
    const refreshBtn = document.getElementById('refreshData');
    const studentsTableBody = document.getElementById('studentsTableBody');
    const parentsTableBody = document.getElementById('parentsTableBody');
    const progressOverview = document.getElementById('progressOverview');
    
    // Load admin data
    loadAdminData();
    
    // Refresh button
    refreshBtn.addEventListener('click', function() {
        loadAdminData();
    });
    
    // Load admin data
    async function loadAdminData() {
        try {
            // Load students
            const studentsResponse = await fetch('/api/admin/students');
            const studentsData = await studentsResponse.json();
            
            if (studentsResponse.ok) {
                updateStudentsTable(studentsData.students);
                updateStats(studentsData.students);
            } else {
                console.error('Failed to load students:', studentsData.error);
            }
            
            // Load parents
            const parentsResponse = await fetch('/api/admin/parents');
            const parentsData = await parentsResponse.json();
            
            if (parentsResponse.ok) {
                updateParentsTable(parentsData.parents);
            } else {
                console.error('Failed to load parents:', parentsData.error);
            }
            
        } catch (error) {
            console.error('Admin data load error:', error);
            showAlert('error', 'Failed to load admin data');
        }
    }
    
    // Update students table
    function updateStudentsTable(students) {
        if (students.length === 0) {
            studentsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No students found</td></tr>';
            return;
        }
        
        studentsTableBody.innerHTML = students.map(student => {
            const progress = student.progress || {};
            const progressPercentage = progress.completed_projects ? 
                Math.min((progress.completed_projects / 20) * 100, 100) : 0;
            
            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="student-avatar me-3">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">${student.name}</div>
                                <small class="text-muted">${student.parent_name}</small>
                            </div>
                        </div>
                    </td>
                    <td>${student.age}</td>
                    <td>
                        <span class="badge bg-${getLevelColor(student.level)}">${student.level}</span>
                    </td>
                    <td>
                        <div>
                            <div class="fw-semibold">${student.parent_name}</div>
                            <small class="text-muted">${student.parent_email}</small>
                        </div>
                    </td>
                    <td>
                        <div class="progress" style="width: 100px; height: 8px;">
                            <div class="progress-bar" role="progressbar" style="width: ${progressPercentage}%"></div>
                        </div>
                        <small class="text-muted">${progress.completed_projects || 0} projects</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editStudentProgress('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // Update parents table
    function updateParentsTable(parents) {
        if (parents.length === 0) {
            parentsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No parents found</td></tr>';
            return;
        }
        
        parentsTableBody.innerHTML = parents.map(parent => {
            const joinDate = new Date(parent.created_at).toLocaleDateString();
            
            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="parent-avatar me-3">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <div class="fw-semibold">${parent.name}</div>
                        </div>
                    </td>
                    <td>${parent.email}</td>
                    <td>
                        <span class="badge bg-info">${parent.student_count} student${parent.student_count !== 1 ? 's' : ''}</span>
                    </td>
                    <td>${joinDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editParent('${parent.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // Update statistics
    function updateStats(students) {
        const totalStudents = students.length;
        const totalParents = new Set(students.map(s => s.parent_id)).size;
        const totalProjects = students.reduce((sum, s) => sum + (s.progress?.completed_projects || 0), 0);
        const totalHours = students.reduce((sum, s) => sum + (s.progress?.total_hours || 0), 0);
        
        document.getElementById('totalStudents').textContent = totalStudents;
        document.getElementById('totalParents').textContent = totalParents;
        document.getElementById('totalProjects').textContent = totalProjects;
        document.getElementById('totalHours').textContent = totalHours;
    }
    
    // Get level color
    function getLevelColor(level) {
        switch(level) {
            case 'Beginner': return 'success';
            case 'Intermediate': return 'warning';
            case 'Advanced': return 'danger';
            default: return 'secondary';
        }
    }
    
    // Edit student progress
    window.editStudentProgress = function(studentId) {
        // Find student data
        fetch('/api/admin/students')
            .then(response => response.json())
            .then(data => {
                const student = data.students.find(s => s.id === studentId);
                if (student) {
                    const progress = student.progress || {};
                    
                    document.getElementById('studentId').value = studentId;
                    document.getElementById('currentLevel').value = progress.current_level || student.level;
                    document.getElementById('completedProjects').value = progress.completed_projects || 0;
                    document.getElementById('totalHours').value = progress.total_hours || 0;
                    document.getElementById('achievements').value = progress.achievements || 0;
                    document.getElementById('nextClassDate').value = progress.next_class_date || '';
                    document.getElementById('notes').value = progress.notes || '';
                    
                    const modal = new bootstrap.Modal(document.getElementById('studentProgressModal'));
                    modal.show();
                }
            });
    };
    
    // Edit parent
    window.editParent = function(parentId) {
        fetch('/api/admin/parents')
            .then(response => response.json())
            .then(data => {
                const parent = data.parents.find(p => p.id === parentId);
                if (parent) {
                    document.getElementById('parentId').value = parentId;
                    document.getElementById('parentName').value = parent.name;
                    document.getElementById('parentEmail').value = parent.email;
                    
                    const modal = new bootstrap.Modal(document.getElementById('parentEditModal'));
                    modal.show();
                }
            });
    };
    
    // Save student progress
    document.getElementById('saveProgress').addEventListener('click', async function() {
        const studentId = document.getElementById('studentId').value;
        const formData = new FormData(document.getElementById('progressForm'));
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch(`/api/admin/students/${studentId}/progress`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showAlert('success', 'Student progress updated successfully');
                bootstrap.Modal.getInstance(document.getElementById('studentProgressModal')).hide();
                loadAdminData();
            } else {
                showAlert('error', result.error || 'Failed to update progress');
            }
        } catch (error) {
            console.error('Progress update error:', error);
            showAlert('error', 'Failed to update progress');
        }
    });
    
    // Save parent changes
    document.getElementById('saveParent').addEventListener('click', async function() {
        const parentId = document.getElementById('parentId').value;
        const formData = new FormData(document.getElementById('parentEditForm'));
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch(`/api/admin/parents/${parentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showAlert('success', 'Parent account updated successfully');
                bootstrap.Modal.getInstance(document.getElementById('parentEditModal')).hide();
                loadAdminData();
            } else {
                showAlert('error', result.error || 'Failed to update parent');
            }
        } catch (error) {
            console.error('Parent update error:', error);
            showAlert('error', 'Failed to update parent');
        }
    });
    
    // Delete parent
    document.getElementById('deleteParent').addEventListener('click', async function() {
        if (!confirm('Are you sure you want to delete this parent account? This action cannot be undone.')) {
            return;
        }
        
        const parentId = document.getElementById('parentId').value;
        
        try {
            const response = await fetch(`/api/admin/parents/${parentId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showAlert('success', 'Parent account deleted successfully');
                bootstrap.Modal.getInstance(document.getElementById('parentEditModal')).hide();
                loadAdminData();
            } else {
                showAlert('error', result.error || 'Failed to delete parent');
            }
        } catch (error) {
            console.error('Parent deletion error:', error);
            showAlert('error', 'Failed to delete parent');
        }
    });
    
    // Alert function
    function showAlert(type, message) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create new alert
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
